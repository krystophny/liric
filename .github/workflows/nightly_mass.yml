name: Nightly Mass Campaign

on:
  schedule:
    - cron: "20 3 * * *"
  workflow_dispatch:

permissions:
  contents: read
  actions: read

concurrency:
  group: nightly-mass-${{ github.ref }}
  cancel-in-progress: false

jobs:
  mass-nightly:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, macos-14]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 360
    env:
      LFORTRAN_ROOT: ${{ github.workspace }}/lfortran
      LFORTRAN_BUILD: ${{ github.workspace }}/lfortran/build
      LFORTRAN_BUILD_LIRIC: ${{ github.workspace }}/lfortran/build-liric
      LIRIC_BUILD: ${{ github.workspace }}/build
      MASS_OUT: ${{ runner.temp }}/liric_lfortran_mass
      BASELINE_DIR: ${{ runner.temp }}/liric_lfortran_mass_baseline/${{ matrix.os }}

    steps:
      - name: Checkout liric
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout lfortran
        uses: actions/checkout@v4
        with:
          repository: lfortran/lfortran
          path: lfortran
          fetch-depth: 0

      - name: Install Linux deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake bison re2c zstd jq

      - name: Install macOS deps
        if: runner.os == 'macOS'
        run: |
          brew install ninja bison re2c zstd jq

      - name: Restore baseline cache
        id: baseline_restore
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.BASELINE_DIR }}
          key: nightly-mass-${{ matrix.os }}-${{ github.run_id }}
          restore-keys: |
            nightly-mass-${{ matrix.os }}-

      - name: Build lfortran
        run: |
          cmake -S "${LFORTRAN_ROOT}" -B "${LFORTRAN_BUILD}" -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build "${LFORTRAN_BUILD}" -j"$(nproc 2>/dev/null || sysctl -n hw.ncpu)"

      - name: Build liric
        run: |
          cmake -S . -B "${LIRIC_BUILD}" -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build "${LIRIC_BUILD}" -j"$(nproc 2>/dev/null || sysctl -n hw.ncpu)"

      - name: Build lfortran WITH_LIRIC
        if: runner.os == 'Linux'
        run: |
          cmake -S "${LFORTRAN_ROOT}" -B "${LFORTRAN_BUILD_LIRIC}" -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DWITH_LIRIC=yes \
            -DLIRIC_DIR="${GITHUB_WORKSPACE}"
          cmake --build "${LFORTRAN_BUILD_LIRIC}" -j"$(nproc 2>/dev/null || sysctl -n hw.ncpu)"

      - name: Run full mass campaign with regression gate
        run: |
          set -euo pipefail
          mkdir -p "${BASELINE_DIR}" "${MASS_OUT}"
          BASELINE_ARGS=()
          if [[ -f "${BASELINE_DIR}/baseline.jsonl" ]]; then
            BASELINE_ARGS=(--baseline "${BASELINE_DIR}/baseline.jsonl")
          fi
          ./tools/lfortran_mass/nightly_mass.sh \
            --lfortran-root "${LFORTRAN_ROOT}" \
            --lfortran-bin "${LFORTRAN_BUILD}/src/bin/lfortran" \
            --probe-runner "${LIRIC_BUILD}/liric_probe_runner" \
            --output-root "${MASS_OUT}" \
            --workers "$(nproc 2>/dev/null || sysctl -n hw.ncpu)" \
            --diag-fail-logs \
            "${BASELINE_ARGS[@]}"

      - name: Run API clean-pass gate (Linux)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          ./tools/bench_api_clean_gate.sh \
            --build-dir "${LIRIC_BUILD}" \
            --bench-dir "${MASS_OUT}/bench_api_clean_gate" \
            --timeout-ms 3000 \
            --compat-timeout 15 \
            --lfortran "${LFORTRAN_BUILD}/src/bin/lfortran" \
            --lfortran-liric "${LFORTRAN_BUILD_LIRIC}/src/bin/lfortran" \
            --test-dir "${LFORTRAN_ROOT}/integration_tests" \
            --probe-runner "${LIRIC_BUILD}/liric_probe_runner" \
            --runtime-lib "${LFORTRAN_BUILD}/src/runtime/liblfortran_runtime.so" \
            --cmake "${LFORTRAN_ROOT}/integration_tests/CMakeLists.txt" \
            --workers "$(nproc 2>/dev/null || sysctl -n hw.ncpu)"

      - name: Render per-case failure task list
        if: always()
        run: |
          set -euo pipefail
          chmod +x ./tools/lfortran_mass/render_fail_tasklist.sh
          ./tools/lfortran_mass/render_fail_tasklist.sh \
            --results-jsonl "${MASS_OUT}/results.jsonl" \
            --summary-json "${MASS_OUT}/summary.json" \
            --out "${MASS_OUT}/failure_task_list.md"

      - name: Validate README benchmark snapshot contract
        run: |
          set -euo pipefail
          ./tools/bench_readme_perf_gate.sh \
            --readme "${GITHUB_WORKSPACE}/README.md" \
            --snapshot "${GITHUB_WORKSPACE}/docs/benchmarks/readme_perf_snapshot.json" \
            --table "${GITHUB_WORKSPACE}/docs/benchmarks/readme_perf_table.md"

      - name: Publish trend summary
        run: |
          set -euo pipefail
          CURRENT_SUMMARY="${MASS_OUT}/summary.json"
          PREV_SUMMARY="${BASELINE_DIR}/summary.json"
          echo "## Nightly Mass Summary (${RUNNER_OS})" >> "${GITHUB_STEP_SUMMARY}"
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          if [[ -f "${PREV_SUMMARY}" ]]; then
            echo "| Metric | Previous | Current | Delta |" >> "${GITHUB_STEP_SUMMARY}"
            echo "|---|---:|---:|---:|" >> "${GITHUB_STEP_SUMMARY}"
            for key in manifest_total emit_ok parse_ok jit_ok runnable_selected_executable differential_attempted_executable differential_missing_attempts differential_match mismatch_count new_supported_regressions; do
              prev=$(jq -r ".${key} // 0" "${PREV_SUMMARY}")
              cur=$(jq -r ".${key} // 0" "${CURRENT_SUMMARY}")
              delta=$((cur - prev))
              echo "| ${key} | ${prev} | ${cur} | ${delta} |" >> "${GITHUB_STEP_SUMMARY}"
            done
          else
            echo "No previous baseline cache found for this OS; trend deltas start on next run." >> "${GITHUB_STEP_SUMMARY}"
          fi

      - name: Update baseline cache payload
        run: |
          set -euo pipefail
          mkdir -p "${BASELINE_DIR}"
          cp "${MASS_OUT}/results.jsonl" "${BASELINE_DIR}/baseline.jsonl"
          cp "${MASS_OUT}/summary.json" "${BASELINE_DIR}/summary.json"
          cp "${MASS_OUT}/summary.md" "${BASELINE_DIR}/summary.md"

      - name: Save baseline cache
        uses: actions/cache/save@v4
        with:
          path: ${{ env.BASELINE_DIR }}
          key: nightly-mass-${{ matrix.os }}-${{ github.run_id }}

      - name: Upload mass artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-mass-${{ matrix.os }}
          retention-days: 30
          if-no-files-found: error
          path: |
            ${{ env.MASS_OUT }}/manifest_tests_toml.jsonl
            ${{ env.MASS_OUT }}/selection_decisions.jsonl
            ${{ env.MASS_OUT }}/results.jsonl
            ${{ env.MASS_OUT }}/summary.json
            ${{ env.MASS_OUT }}/summary.md
            ${{ env.MASS_OUT }}/failure_task_list.md
            ${{ env.MASS_OUT }}/failures.csv
            ${{ env.MASS_OUT }}/bench_api_clean_gate/compat_check.jsonl
            ${{ env.MASS_OUT }}/bench_api_clean_gate/compat_api.txt
            ${{ env.MASS_OUT }}/bench_api_clean_gate/compat_ll.txt
            ${{ env.MASS_OUT }}/bench_api_clean_gate/bench_api.jsonl
            ${{ env.MASS_OUT }}/bench_api_clean_gate/bench_api_summary.json
            ${{ env.MASS_OUT }}/bench_api_clean_gate/bench_api_failures.jsonl
            ${{ env.MASS_OUT }}/bench_api_clean_gate/bench_api_fail_summary.json
